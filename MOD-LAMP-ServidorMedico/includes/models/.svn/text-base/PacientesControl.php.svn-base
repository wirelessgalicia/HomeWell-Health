<?php

class PacientesControl
{

    public static function listar($idMedico, $filtrado, $paginacion = 0)
    {
        // {{{

        $resultado = array(
            'orden' => null,
            'coleccion' => null,
            'paginador' => null,
            'enlacesPaginador' => null,
        );

        $q = Doctrine_Query::create()
            ->from('Pacientes pac')
            ->where('pac.id_medico = ?', $idMedico)
            ;

        // GestiÃ³n Orden {{{

        $orden = new SortColumn(basename(__FILE__)); 

        $orden->add('apellidos', 'Apellidos', 'pac.apellidos', 1);
        $orden->add('nombre', 'Nombre', 'pac.nombre');
        $orden->add('nacimiento', 'Nacimiento', 'pac.fecha_nacimiento');
        $orden->add('sexo', 'Sexo', 'pac.sexo');
        $orden->add('estado', 'Estado', 'pac.estado');

        $orden_sql = $orden->sql();
        if (!empty($orden_sql)){
            $q->orderBy($orden_sql);
        }

        $resultado['orden'] = $orden;

        // }}}

        // Filtrado {{{
        // Condicion nombre, Tipo cadena {{{
        if (    
            isset($filtrado['nombre']) 
            && !empty($filtrado['nombre']) 
        ){
            $q->addWhere('pac.nombre like ?', '%' . $filtrado['nombre'] . '%');
        }
        // }}}
        // Condicion apellidos, Tipo cadena {{{
        if (    
            isset($filtrado['apellidos']) 
            && !empty($filtrado['apellidos']) 
        ){
            $q->addWhere('pac.apellidos like ?', '%' . $filtrado['apellidos'] . '%');
        }
        // }}}
        // Condicion no_tis, Tipo cadena {{{
        if (    
            isset($filtrado['no_tis']) 
            && !empty($filtrado['no_tis']) 
        ){
            $q->addWhere('pac.no_tis = ?', $filtrado['no_tis']);
        }
        // }}}
        // Condicion domicilio, Tipo cadena {{{
        if (    
            isset($filtrado['domicilio']) 
            && !empty($filtrado['domicilio']) 
        ){
            $q->addWhere('pac.domicilio like ?', '%' . $filtrado['domicilio'] . '%');
        }
        // }}}
        // }}}

        // Paginacion {{{

        if ($paginacion > 0) {
            // Paginamos {{{
            $resultado = array_merge($resultado, Paginacion::paginar($q, $paginacion));
            // }}}
        } else {
            // No paginamos {{{
            $resultado['coleccion'] = $q->execute();
            // }}}
        }

        // }}}

        return $resultado;

        // }}}
    }

    public static function obtenerRegistroPorId($idPaciente)
    {
        // {{{

        return Doctrine::getTable('Pacientes')->find($idPaciente);

        // }}}
    }


}
